<!DOCTYPE>
<html lang="en">
<head>
    <title>聊天室</title>
	<meta charset="utf-8">
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
    <style>
        body {
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">当前登录用户</h3>
                </div>
                <div class="panel-body">
                    <div class="list-group">
                        <a href="#" class="list-group-item">你好，<span id="user"></span></a>
                        <button id="connect" type="button" class="btn btn-primary">连接</button>
                        <button id="disconnect" type="button" class="btn btn-primary">关闭</button>
                    </div>
                </div>
            </div>
            <div class="panel panel-primary" id="online">
                <div class="panel-heading">
                    <h3 class="panel-title">在线用户</h3>
                </div>
                <div class="panel-body">
                    <div class="list-group" id="users">
                    </div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">系统广播</h3>
                </div>
                <div class="panel-body">
                    <input type="text" class="form-control" id="msg"/><br>
                    <button id="broadcast" type="button" class="btn btn-primary">发送</button>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title" id="talktitle"></h3>
                </div>
                <div class="panel-body">
                    <div class="well" id="log-container" style="height:400px;overflow-y:scroll">

                    </div>
                    <input type="text" id="myinfo" class="form-control col-md-12"/> <br>
                    <button id="send" type="button" class="btn btn-primary">发送</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
var ws;
var user;
$(function () {
	/*
	模拟获取token
	*/
    $.ajax({
        url:"/currentuser",
        success:function (res) {
        	user=res;
        	$("#user").text(res);
        },
        async:false //同步请求，只有上面好了才会接着下面
    });
});

$("#connect").click(function () {
	if ("WebSocket" in window) {
        ws = new WebSocket("ws://localhost:8080/chat/"+user);
        ws.onopen = function (ev) {
        	setConnect(true);
        	$("#status").text("连接成功");
            console.log("ws服务器连接成功");
        }

        /**服务器发送数据后，自动触发此方法，客户端进行获取数据，使用 evt.data 获取数据*/
        ws.onmessage = function (evt) {
            var data = JSON.parse(evt.data);
            if (data.type == 'broadcast') {//广播消息
                if (data.from != user) {
                	if(data.dataType == 'online'){
                		$("#users").append('<a href="#" onclick="talk(this)" class="list-group-item">' + data.from + '</a>');                		
                		$("#log-container").append("<div class='bg-info'><label class='text-danger'>" + data.from + "&nbsp;" + transformDate(data.sentTime) + "</label><div class='text-success'>" + data.body + "</div></div><br>");
                	}else if(data.dataType == 'offline'){
                		$("#log-container").append("<div class='bg-info'><label class='text-danger'>" + data.from + "&nbsp;" + transformDate(data.sentTime) + "</label><div class='text-success'>" + data.body + "</div></div><br>");
                		$("#users > a").remove(":contains('" + data.from + "')");
                	}else{
                		$("#log-container").append("<div class='bg-info'><label class='text-danger'>" + data.from + "&nbsp;" + transformDate(data.sentTime) + "</label><div class='text-success'>" + data.body + "</div></div><br>");
                	}
                }
            } else if (data.type == 'chat') {//chat消息
            	$("#log-container").append("<div class='bg-info'><label class='text-danger'>" + data.from + "&nbsp;" + transformDate(data.sentTime) + "</label><div class='text-success'>" + data.body + "</div></div><br>");
            } else if (data.type == 'groupchat') {//groupchat消息
            
            } else {
            	//错误消息todo
            }
            console.log("接收到服务器数据：" + data);
        };

        /**客户端与服务器数据传输错误时触发*/
        ws.onerror = function (evt) {
            console.log("客户端与服务器数据传输错误...");
        };

        /**web Socket 连接关闭时触发*/
        ws.onclose = function () {
        	setConnect(false);
        	$("#status").text("连接关闭");
            console.log("ws服务器连接关闭");
        };
    } else {
        alert("您的浏览器不支持 WebSocket!");
    }
});

$("#disconnect").click(function () {
    if (ws != null) {
    	ws.close();
    }
    setConnect(false);
});

$("#broadcast").click(function () {
    var data = {};
    data["from"] = "系统广播";
    data["type"] = "broadcast";
    data["body"] = $("#msg").val();
    ws.send(JSON.stringify(data));
});

$("#send").click(function () {
    if ($("body").data("to") == undefined) {
        alert("请选择聊天对象");
        return false;
    }
    var data = {};
    data["from"] = user;
    data["to"] = $("body").data("to");
    data["type"] = "chat";
    data["body"] = $("#myinfo").val();
    ws.send(JSON.stringify(data));
    $("#log-container").append("<div class='bg-success'><label class='text-info'>我&nbsp;" + new Date().format("yyyy-MM-dd hh:mm:ss") + "</label><div class='text-info'>" + $("#myinfo").val() + "</div></div><br>");
    scrollToBottom();
    $("#myinfo").val("");
});

function talk(a) {
    $("#talktitle").text("与" + a.innerHTML + "的聊天");
    $("body").data("to", a.innerHTML);
}

function scrollToBottom() {
    var div = document.getElementById('log-container');
    div.scrollTop = div.scrollHeight;
}

//设置按钮
function setConnect(connectStatus) {
    $("#connect").attr("disabled", connectStatus);
    $("#disconnect").attr("disabled", !connectStatus);
}

function transformDate(timestamp) {
	let date = new Date(timestamp);
	let y = date.getFullYear();
	let m = date.getMonth() + 1; //月份从0开始，需要加1
	m = m < 10 ? ('0' + m) : m   
	let d = date.getDate();
	d = d < 10 ? ('0' + d) : d  
	let hh = date.getHours();
	hh = hh < 10 ? ('0' + hh) : hh; 
	let mm = date.getMinutes();
	let ss = date.getSeconds();
	mm = mm < 10 ? ('0' + mm) : mm;
	ss = ss < 10 ? ('0' + ss) : ss;
	return `${y}-${m}-${d} ${hh}:${mm}:${ss}`
}

Date.prototype.format = function (fmt) {
    var o = {
        "M+": this.getMonth() + 1,                 //月份
        "d+": this.getDate(),                    //日
        "h+": this.getHours(),                   //小时
        "m+": this.getMinutes(),                 //分
        "s+": this.getSeconds(),                 //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds()             //毫秒
    };
    if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        }
    }
    return fmt;
}

</script>

</body>
</html>
